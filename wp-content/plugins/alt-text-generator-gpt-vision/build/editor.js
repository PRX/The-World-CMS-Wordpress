(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.hooks,n=window.wp.blockEditor,r=window.wp.components,i=window.wp.data,s=window.wp.element,a=window.wp.i18n,o=window.wp.htmlEntities,l=window.wp.coreData,d=window.wp.apiFetch;var c=e.n(d);const h=async(e,t=!1,n,r)=>{const i={attachment_id:e,save:t};return n?.length&&(i.user_prompt=n),c()({path:"acpl/ai-alt-generator",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:r}).then(e=>e.alt).catch(e=>{throw console.error(e),e})};function x(e){return new Promise(t=>setTimeout(t,e))}const g=window.wp.primitives,u=window.ReactJSXRuntime,p=(0,u.jsx)(g.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,u.jsx)(g.Path,{d:"M16.7 7.1l-6.3 8.5-3.3-2.5-.9 1.2 4.5 3.4L17.9 8z"})}),w=(0,u.jsx)(g.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,u.jsx)(g.Path,{d:"M6.6 6L5.4 7l4.5 5-4.5 5 1.1 1 5.5-6-5.4-6zm6 0l-1.1 1 4.5 5-4.5 5 1.1 1 5.5-6-5.5-6z"})}),m=(0,u.jsx)(g.SVG,{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",children:(0,u.jsx)(g.Path,{d:"M12 4C7.58172 4 4 7.58172 4 12C4 16.4183 7.58172 20 12 20C16.4183 20 20 16.4183 20 12C20 7.58172 16.4183 4 12 4ZM12.75 8V13H11.25V8H12.75ZM12.75 14.5V16H11.25V14.5H12.75Z"})});function v({details:e}){const{status:t,message:n}=e;return(0,u.jsx)(r.Flex,{justify:"start",children:"generating"===t?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Spinner,{}),(0,a._x)("Generating...","Generation status","alt-text-generator-gpt-vision")]}):"generated"===t?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Icon,{icon:p}),(0,a._x)("Generated","Generation status","alt-text-generator-gpt-vision")]}):"skipped"===t?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Icon,{icon:w}),(0,a._x)("Skipped","Generation status","alt-text-generator-gpt-vision")]}):"error"===t?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(r.Icon,{icon:m}),(0,a.sprintf)((0,a._x)("Error: %s","Generation status","alt-text-generator-gpt-vision"),n)]}):null})}function j({loading:e,generationMap:t}){return(0,u.jsx)("div",{style:{maxHeight:"18rem",overflowY:"auto",marginBottom:"1rem",border:"1px solid #c3c4c7"},children:(0,u.jsxs)("table",{className:"wp-list-table fixed widefat striped",style:{border:"0"},children:[(0,u.jsx)("thead",{style:{position:"sticky",top:"0",backgroundColor:"white",zIndex:1},children:(0,u.jsxs)("tr",{children:[(0,u.jsx)("th",{children:(0,a.__)("File","alt-text-generator-gpt-vision")}),(0,u.jsx)("th",{children:(0,a.__)("Alt text","alt-text-generator-gpt-vision")}),(0,u.jsx)("th",{children:(0,a.__)("Status","alt-text-generator-gpt-vision")})]})}),(0,u.jsx)("tbody",{children:e?Array.from(t,([e,t])=>(0,u.jsxs)("tr",{children:[(0,u.jsx)("td",{children:(0,u.jsx)("a",{href:t.source_url,target:"_blank",style:{lineBreak:"anywhere"},children:(0,u.jsxs)(r.Flex,{align:"start",justify:"start",children:[t.thumbnail&&(0,u.jsx)("img",{src:t.thumbnail.source_url,height:t.thumbnail.height,width:t.thumbnail.width,alt:t.alt,loading:"lazy",decoding:"async",style:{maxWidth:"60px",height:"auto"}}),t.title]})})}),(0,u.jsx)("td",{children:t.alt}),(0,u.jsx)("td",{children:(0,u.jsx)(v,{details:t})})]},e)):(0,u.jsx)("tr",{children:(0,u.jsx)("td",{colSpan:3,style:{textAlign:"center"},children:(0,u.jsx)(r.Spinner,{})})})})]})})}const _=(0,a.__)("Custom prompt (optional)","alt-text-generator-gpt-vision"),b=(0,a.__)("Provide custom instructions for AI to tailor the alt text generation, such as including specific keywords for SEO.","alt-text-generator-gpt-vision"),f=(0,a._x)('e.g. Include terms like "AI", "robotics"',"Additional prompt placeholder","alt-text-generator-gpt-vision");function y({rows:e=1,label:t=_,help:n=b,placeholder:i=f,...s}){return(0,u.jsx)(r.TextareaControl,{rows:e,label:t,help:n,placeholder:i,style:{fieldSizing:"content",maxBlockSize:"6rlh"},...s})}const C=(0,u.jsx)(g.SVG,{viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,u.jsx)(g.Path,{fillRule:"evenodd",clipRule:"evenodd",d:"M5.5 12a6.5 6.5 0 1 0 13 0 6.5 6.5 0 0 0-13 0ZM12 4a8 8 0 1 0 0 16 8 8 0 0 0 0-16Zm-.75 12v-1.5h1.5V16h-1.5Zm0-8v5h1.5V8h-1.5Z"})}),k=({showIcon:e=!0})=>(0,u.jsxs)(r.Flex,{align:"center",justify:"end",gap:1,children:[e&&(0,u.jsx)(r.Icon,{icon:C,size:22}),(0,u.jsx)("small",{children:(0,a.__)("AI can make mistakes. Please double-check generated text.","alt-text-generator-gpt-vision")})]}),S=(0,a.__)("Save alt text in media library","alt-text-generator-gpt-vision");function A({label:e=S,checked:t,onChange:n,disabled:i=!1}){return(0,u.jsx)(r.ToggleControl,{label:e,checked:t,onChange:n,help:t?(0,a.__)("Alternative text will be saved in the WordPress media library, making it available for reuse across site.","alt-text-generator-gpt-vision"):(0,a.__)("Alternative text will only be saved for the current editor block.","alt-text-generator-gpt-vision"),disabled:i})}function I({attachmentIds:e,onGenerate:t,onClose:n,context:i="mediaLibrary"}){const[d,c]=(0,s.useState)(!1),[g,p]=(0,s.useState)(""),[w,m]=(0,s.useState)("mediaLibrary"===i),[v,_]=(0,s.useState)(!1),{attachments:b,hasResolved:f}=function(e){const{records:t,hasResolved:n,isResolving:r}=(0,l.useEntityRecords)("postType","attachment",{include:e,per_page:-1,context:"view"});return{attachments:null!=t?t:[],hasResolved:n}}(e),[C,S]=(0,s.useState)(new Map(e.map(e=>[e,{status:"",alt:""}]))),I=(0,s.useRef)(new AbortController);return(0,s.useEffect)(()=>{b.length&&S(e=>{const t=new Map(e);return b.forEach(e=>{var n,r;const i=t.get(e.id);if(!i)return void console.error("Generation details not found for attachment",e);i.alt=e.alt_text,i.title=(0,o.decodeEntities)(e.title.rendered),i.source_url=e.source_url;const s=null!==(n=null!==(r=e.media_details.sizes?.thumbnail)&&void 0!==r?r:e.media_details.sizes?.[0])&&void 0!==n?n:{width:e.media_details.width,height:e.media_details.height,source_url:e.source_url};s&&(i.thumbnail={width:s.width,height:s.height,source_url:s.source_url}),t.set(e.id,i)}),t})},[b,f]),(0,s.useEffect)(()=>()=>{I.current.abort()},[]),(0,u.jsxs)(r.Modal,{title:(0,a.__)("Generate Alternative Texts","alt-text-generator-gpt-vision"),onRequestClose:n,shouldCloseOnClickOutside:!1,shouldCloseOnEsc:!v,style:{maxWidth:"48rem"},children:[(0,u.jsx)(y,{value:g,onChange:p,disabled:v}),(0,u.jsx)(r.ToggleControl,{label:(0,a.__)("Overwrite existing alternative texts","alt-text-generator-gpt-vision"),help:d?(0,a.__)("The existing alternative texts will be overwritten with the new ones.","alt-text-generator-gpt-vision"):(0,a.__)("The existing alternative texts will be preserved.","alt-text-generator-gpt-vision"),checked:d,onChange:c,disabled:v}),"editor"===i&&(0,u.jsx)(A,{checked:w,onChange:m,disabled:v}),(0,u.jsx)(j,{loading:f,generationMap:C}),(0,u.jsx)(k,{}),(0,u.jsxs)(r.Flex,{children:[(0,u.jsx)("p",{children:(0,a.sprintf)((0,a._n)("%d image selected","%d images selected",e.length,"alt-text-generator-gpt-vision"),e.length)}),(0,u.jsx)(r.FlexItem,{children:(0,u.jsxs)(r.Flex,{justify:"end",children:[(0,u.jsx)(r.Button,{onClick:n,isDestructive:!0,children:(0,a.__)("Cancel","alt-text-generator-gpt-vision")}),(0,u.jsx)(r.Button,{variant:"primary",disabled:v||!f,isBusy:v,onClick:async()=>{I.current=new AbortController,_(!0);const e=[];for(const[n,r]of C){if(!d&&r.alt.length>0){S(e=>new Map(e.set(n,{...r,status:"skipped"})));continue}S(e=>new Map(e.set(n,{...r,status:"generating"})));const i=h(n,w,g,I.current.signal).then(e=>{const i=b.find(e=>e.id===n);i&&(i.alt_text=e),S(t=>new Map(t.set(n,{...r,alt:e,status:"generated"}))),t&&t({id:n,alt:e})}).catch(e=>{S(t=>new Map(t.set(n,{...r,status:"error",message:e.message}))),console.error(e)});e.push(i),await x(1e3)}await Promise.all(e),_(!1),document.dispatchEvent(new CustomEvent("altTextsGenerated"))},children:(0,a.__)("Start","alt-text-generator-gpt-vision")})]})})]})]})}const G=({clientId:e})=>{const[t,o]=(0,s.useState)(!1),l=(0,i.useSelect)(t=>t(n.store).getBlock(e).innerBlocks,[e]),d=(0,s.useMemo)(()=>{var e;return null!==(e=l.filter(e=>"core/image"===e.name))&&void 0!==e?e:[]},[l]),c=(0,s.useMemo)(()=>l.filter(e=>e.attributes?.id).map(e=>e.attributes.id),[l]);return 0===c.length?null:(0,u.jsx)(n.InspectorControls,{children:(0,u.jsx)(r.Panel,{children:(0,u.jsxs)(r.PanelBody,{title:(0,a.__)("Alternative Text Generator","alt-text-generator-gpt-vision"),children:[(0,u.jsx)(r.Button,{variant:"primary",onClick:()=>o(!0),children:(0,a.__)("Generate alternative texts","alt-text-generator-gpt-vision")}),t&&(0,u.jsx)(I,{context:"editor",attachmentIds:c,onClose:()=>o(!1),onGenerate:({id:e,alt:t})=>{const r=d.find(t=>t.attributes.id===e);r&&(0,i.dispatch)(n.store).updateBlockAttributes(r.clientId,{alt:t})}})]})})})},M=window.wp.notices,B=({imgId:e,currentAlt:t="",onGenerate:n,customPrompt:o,saveAltInMediaLibrary:l=!1})=>{const[d,c]=(0,s.useState)(!1),{createSuccessNotice:x,createErrorNotice:g}=(0,i.useDispatch)(M.store);return(0,u.jsx)(r.Button,{variant:"primary",onClick:async()=>{if(!t.length||confirm((0,a.__)("Are you sure you want to overwrite the existing alt text?","alt-text-generator-gpt-vision")))try{c(!0);const t=await h(e,l,o);n(t),await x((0,a.__)("Alternative text generated","alt-text-generator-gpt-vision"),{type:"snackbar",id:"alt-text-generated"})}catch(e){e.message&&await g((0,a.sprintf)((0,a.__)("There was an error generating the alt text: %s","alt-text-generator-gpt-vision"),e.message),{id:"alt-text-error",type:"default"})}finally{c(!1)}},isBusy:d,disabled:d,children:(0,a.__)("Generate alternative text","alt-text-generator-gpt-vision")})},P=({attributes:e,setAttributes:t})=>{if(!e.id)return null;const[i,o]=(0,s.useState)(""),[l,d]=(0,s.useState)(!1);return(0,u.jsx)(n.InspectorControls,{children:(0,u.jsx)(r.Panel,{children:(0,u.jsxs)(r.PanelBody,{title:(0,a.__)("Alternative Text Generator","alt-text-generator-gpt-vision"),children:[(0,u.jsx)(y,{value:i,onChange:o}),(0,u.jsx)(A,{checked:l,onChange:d}),(0,u.jsx)(B,{imgId:e.id,currentAlt:e.alt,customPrompt:i,onGenerate:e=>t({alt:e}),saveAltInMediaLibrary:l}),(0,u.jsx)(r.PanelRow,{children:(0,u.jsx)(k,{showIcon:!1})})]})})})};(0,t.addFilter)("editor.BlockEdit","acpl/ai-alt-generator",e=>t=>{const{clientId:n,name:r,attributes:i,setAttributes:s}=t;return"core/image"===r?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(e,{...t}),(0,u.jsx)(P,{attributes:i,setAttributes:s})]}):"core/gallery"===r?(0,u.jsxs)(u.Fragment,{children:[(0,u.jsx)(e,{...t}),(0,u.jsx)(G,{clientId:n})]}):(0,u.jsx)(e,{...t})},20)})();
//# sourceMappingURL=editor.js.map